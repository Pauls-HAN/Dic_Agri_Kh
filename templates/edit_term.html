{% extends "base.html" %}

{% block title %}용어 편집 - {{ term.korean_term }} - 캄보디아 농업용어 사전{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">홈</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('search') }}">검색</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('view_term', term_id=term.id) }}">{{ term.korean_term }}</a></li>
                <li class="breadcrumb-item active">편집</li>
            </ol>
        </nav>
        <h2><i class="fas fa-edit me-2"></i>용어 편집</h2>
        <p class="text-muted">"{{ term.korean_term }}" 용어의 정보를 수정합니다.</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="POST" action="{{ url_for('edit_term', term_id=term.id) }}">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>용어 정보 수정
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 기본 용어 정보 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-language me-2"></i>기본 용어 정보
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="korean_term" class="form-label">
                                한국어 용어 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="korean_term" name="korean_term" 
                                   required value="{{ term.korean_term }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="khmer_term" class="form-label">
                                크메르어 용어 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control text-khmer" id="khmer_term" name="khmer_term" 
                                   required value="{{ term.khmer_term }}">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="english_term" class="form-label">영어 용어 (선택)</label>
                            <input type="text" class="form-control" id="english_term" name="english_term" 
                                   value="{{ term.english_term or '' }}">
                        </div>
                    </div>

                    <!-- 분류 정보 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-tags me-2"></i>분류 정보
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">
                                카테고리 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">카테고리 선택</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}" {% if term.category == cat %}selected{% endif %}>
                                    {{ cat }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="difficulty_level" class="form-label">난이도</label>
                            <select class="form-select" id="difficulty_level" name="difficulty_level">
                                <option value="기초" {% if term.difficulty_level == '기초' %}selected{% endif %}>기초</option>
                                <option value="중급" {% if term.difficulty_level == '중급' %}selected{% endif %}>중급</option>
                                <option value="고급" {% if term.difficulty_level == '고급' %}selected{% endif %}>고급</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="tags" class="form-label">태그 (선택)</label>
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   value="{{ term.tags | join(', ') if term.tags else '' }}"
                                   placeholder="쉼표로 구분하여 입력">
                            <div class="form-text">검색에 도움이 되는 키워드를 추가하세요.</div>
                        </div>
                    </div>

                    <!-- 설명 정보 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-file-text me-2"></i>설명 정보
                            </h6>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="korean_definition" class="form-label">
                                한국어 설명 <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="korean_definition" name="korean_definition" 
                                      rows="3" required>{{ term.korean_definition }}</textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="khmer_definition" class="form-label">
                                크메르어 설명 <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control text-khmer" id="khmer_definition" name="khmer_definition" 
                                      rows="3" required>{{ term.khmer_definition }}</textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="usage_example" class="form-label">사용 예시 (선택)</label>
                            <textarea class="form-control" id="usage_example" name="usage_example" 
                                      rows="2">{{ term.usage_example or '' }}</textarea>
                        </div>
                    </div>

                    <!-- 검증 상태 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-check-circle me-2"></i>검증 상태
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="verified" name="verified" 
                                       {% if term.verified %}checked{% endif %}>
                                <label class="form-check-label" for="verified">
                                    <strong>검증 완료</strong>
                                    <br><small class="text-muted">이 용어의 번역과 설명이 정확함을 확인했습니다.</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{{ url_for('view_term', term_id=term.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>취소
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-2"></i>삭제
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>변경사항 저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- 사이드바 -->
    <div class="col-lg-4">
        <!-- 편집 히스토리 -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>편집 정보
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>ID:</strong> {{ term.id }}
                </div>
                <div class="mb-3">
                    <strong>생성일:</strong><br>
                    <small class="text-muted">{{ term.created_date or '정보 없음' }}</small>
                </div>
                <div class="mb-3">
                    <strong>마지막 수정:</strong><br>
                    <small class="text-muted">{{ term.updated_date or '정보 없음' }}</small>
                </div>
                <div>
                    <strong>현재 상태:</strong><br>
                    <span class="badge bg-{{ 'success' if term.verified else 'warning' }}">
                        {{ '검증 완료' if term.verified else '검증 대기' }}
                    </span>
                </div>
            </div>
        </div>

        <!-- 편집 도움말 -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>편집 가이드
                </h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-check text-success me-2"></i>편집 시 주의사항</h6>
                <ul class="list-unstyled ms-3 small">
                    <li>• 정확한 번역 확인</li>
                    <li>• 맞춤법 검사</li>
                    <li>• 일관된 용어 사용</li>
                    <li>• 적절한 카테고리 분류</li>
                </ul>

                <h6><i class="fas fa-star text-warning me-2"></i>검증 기준</h6>
                <ul class="list-unstyled ms-3 small">
                    <li>• 전문가 검토 완료</li>
                    <li>• 현지 사용 확인</li>
                    <li>• 문법적 정확성</li>
                    <li>• 의미 전달의 명확성</li>
                </ul>
            </div>
        </div>

        <!-- 관련 작업 -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>관련 작업
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_term') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus me-2"></i>새 용어 추가
                    </a>
                    <a href="{{ url_for('search', category=term.category) }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-search me-2"></i>같은 카테고리 용어
                    </a>
                    <a href="{{ url_for('statistics') }}" class="btn btn-info btn-sm">
                        <i class="fas fa-chart-bar me-2"></i>프로젝트 통계
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">용어 삭제</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>정말로 이 용어를 삭제하시겠습니까?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>경고:</strong> 삭제된 용어는 복구할 수 없습니다.
                </div>
                <div class="bg-light p-3 rounded">
                    <strong>{{ term.korean_term }}</strong> ({{ term.khmer_term }})
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <form method="POST" action="{{ url_for('delete_term', term_id=term.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>삭제 확인
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 폼 변경사항 추적
let originalFormData = {};

document.addEventListener('DOMContentLoaded', function() {
    // 원본 폼 데이터 저장
    const form = document.querySelector('form');
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        originalFormData[key] = value;
    }
    
    // 체크박스도 별도로 처리
    originalFormData['verified'] = document.getElementById('verified').checked;
    
    // 폼 유효성 검사
    form.addEventListener('submit', function(e) {
        const requiredFields = ['korean_term', 'khmer_term', 'category', 'korean_definition', 'khmer_definition'];
        let isValid = true;
        
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('필수 항목을 모두 입력해주세요.');
        }
    });
    
    // 실시간 변경사항 감지
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            checkChanges();
        });
    });
    
    // 실시간 글자 수 카운터
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        const counter = document.createElement('small');
        counter.className = 'text-muted mt-1';
        textarea.parentNode.appendChild(counter);
        
        function updateCounter() {
            const length = textarea.value.length;
            counter.textContent = `${length}자`;
        }
        
        textarea.addEventListener('input', updateCounter);
        updateCounter();
    });
});

// 변경사항 확인
function checkChanges() {
    const form = document.querySelector('form');
    const currentData = new FormData(form);
    let hasChanges = false;
    
    // 입력 필드 확인
    for (let [key, value] of currentData.entries()) {
        if (originalFormData[key] !== value) {
            hasChanges = true;
            break;
        }
    }
    
    // 체크박스 확인
    const currentVerified = document.getElementById('verified').checked;
    if (originalFormData['verified'] !== currentVerified) {
        hasChanges = true;
    }
    
    // 저장 버튼 상태 업데이트
    const saveBtn = document.querySelector('button[type="submit"]');
    if (hasChanges) {
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-warning');
        saveBtn.innerHTML = '<i class="fas fa-exclamation me-2"></i>변경사항 저장';
    } else {
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>변경사항 저장';
    }
}

// 페이지 떠나기 전 경고
window.addEventListener('beforeunload', function(e) {
    const form = document.querySelector('form');
    const currentData = new FormData(form);
    let hasChanges = false;
    
    for (let [key, value] of currentData.entries()) {
        if (originalFormData[key] !== value) {
            hasChanges = true;
            break;
        }
    }
    
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '저장하지 않은 변경사항이 있습니다. 정말 떠나시겠습니까?';
    }
});
</script>
{% endblock %}